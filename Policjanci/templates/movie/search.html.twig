{% extends 'base.html.twig' %}

{% block title %}Search results ‚Äì PlusFlix{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/heart.css') }}">

    <!-- STYLES -->
    <style>
        .search-page { padding: 30px; }

        /* FORMULARZ */
        .search-form { width: 50%; margin: 0 auto; display: flex; }
        .search-input {
            width: 100%; padding: 12px; background: #000;
            border: 1px solid #555; color: white; font-size: 16px;
        }
        .search-btn { width: 60px; background: #333; border: 1px solid #555; border-left: none; color: white; cursor: pointer; }
        .search-btn:hover { background: #555; }

        /* SERWISY */
        .service-label { margin-top: 25px; font-size: 14px; color: #bbb; text-align: center; }
        .service-icons { display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; }

        .service-item { text-align: center; font-size: 12px; color: #ccc; }
        .service-item img { width: 40px; height: 40px; object-fit: contain; margin-bottom: 5px; }

        /* FILTRY */
        .filter-bar { display: flex; justify-content: center; gap: 12px; margin-bottom: 25px; flex-wrap: wrap; }
        .filter-btn {
            background: #2d2d2d; padding: 6px 14px; border-radius: 4px;
            font-size: 14px; color: white; border: 1px solid #444;
        }
        .filter-btn:hover { background: #444; }
        .reset { background: #a80000; }

        /* FILTR OKNA */
        .filter-box {
            background: #111; border: 1px solid #444; padding: 20px; width: 50%;
            margin: 10px auto; border-radius: 6px; color: white; text-align: center;
        }
        .hidden { display: none; }

        /* FILMY */
        .movies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
        }
        .movie-card { background: #1f1f1f; border-radius: 4px; overflow: hidden; transition: .3s; }
        .movie-card img { width: 100%; height: 230px; object-fit: cover; }
        .movie-card:hover { transform: scale(1.05); }
        .movie-title { text-align: center; padding: 10px; }

        .not-found { text-align: center; font-size: 18px; color: #bbb; margin-top: 30px; }

        .selected-filters {
            background: #111;
            padding: 10px 20px;
            border: 1px solid #333;
            width: 80%;
            margin: 10px auto 25px;
            border-radius: 6px;
            color: #eee;
        }

        .tag {
            background: #333;
            padding: 5px 10px;
            border-radius: 4px;
            margin-right: 8px;
            display: inline-block;
            margin-top: 5px;
        }

        .clear-filters {
            margin-left: 10px;
            color: #e50914;
            font-weight: bold;
        }

        .like-bar {
            text-align: center;
            padding: 6px;
            background: #151515;
        }

        .poster-wrapper {
            position: relative;
        }
    </style>

    <!-- STYLE ‚Äì LIKE BUTTON -->
    <style>
        .like-btn {
            cursor: pointer;
            margin-left: 10px;
            color: #aaa;
            transition: 0.2s;
        }

        .like-btn.liked {
            color: #00c853;
        }

        .like-count {
            margin-left: 5px;
            font-size: 14px;
            color: #ccc;
        }
    </style>
{% endblock %}

{% block body %}

    <div class="search-page">

        <!-- SEARCH -->
        <form action="{{ path('app_search') }}" method="get" class="search-form">
            <input type="text" name="prompt" placeholder="Search..." value="{{ prompt }}" class="search-input">
            <button class="search-btn">üîç</button>
        </form>

        <!-- SERVICES -->
        <div class="service-label">Services and filters</div>

        <div class="service-icons">

            {% for service in availableServices %}
                <div class="service-item">
                    <img src="{{ asset(service.logoPath) }}" alt="{{ service.fullName }}">
                    <span>{{ service.fullName }}</span>
                </div>
            {% endfor %}

        </div>

        {# ---- SELECTED FILTERS ---- #}
        {% if selectedCategories is not empty
            or prompt
            or type
            or minScore
            or maxScore
            or yearAfter
            or yearBefore
            or country
            or isRated18 is not null %}

        <div class="selected-filters">
            <strong>Selected filters:</strong>

            {% if prompt %}
                <span class="tag">Search: "{{ prompt }}"</span>
            {% endif %}

            {% if selectedCategories is not empty %}
                <span class="tag">Category: {{ selectedCategories|join(', ') }}</span>
            {% endif %}

            {% if type %}
                <span class="tag">Type: {{ type == 'film' ? 'Film' : 'Series' }}</span>
            {% endif %}

            {% if yearAfter or yearBefore %}
                <span class="tag">Year: {{ yearAfter ?? '?' }} ‚Äì {{ yearBefore ?? '?' }}</span>
            {% endif %}

            {% if country %}
                <span class="tag">Country: {{ country }}</span>
            {% endif %}

            {% if minScore or maxScore %}
                <span class="tag">Rating: {{ minScore ?? 0 }}‚Äì{{ maxScore ?? 100 }}</span>
            {% endif %}

            {% if isRated18 is not null %}
                <span class="tag">18+: {{ isRated18 ? 'Tak' : 'Nie' }}</span>
            {% endif %}

            <a href="{{ path('app_search') }}" class="clear-filters">Clear</a>
        </div>

        {% endif %}

        {# ---- FILTER BUTTONS ---- #}
        <div class="filter-bar">

            <a href="{{ path('app_search', app.request.query.all | merge({'type': null})) }}" class="filter-btn">All</a>

            <a href="{{ path('app_search', app.request.query.all | merge({'type': 'film'})) }}" class="filter-btn">Films</a>

            <a href="{{ path('app_search', app.request.query.all | merge({'type': 'series'})) }}" class="filter-btn">Series</a>

            <a href="#" onclick="toggleCategoryFilter()" class="filter-btn">Category</a>

            <a href="#" onclick="toggleYearFilter()" class="filter-btn">Year</a>

            <a href="#" onclick="toggleCountryFilter()" class="filter-btn">Country</a>

            <a href="#" onclick="toggleScoreFilter()" class="filter-btn">Rating</a>

            <a href="{{ path('app_search', app.request.query.all | merge({'isRated18': 1})) }}" class="filter-btn">18+</a>

            <a href="{{ path('app_search') }}" class="filter-btn reset">Reset</a>
        </div>

        <!-- FILTER: CATEGORY -->
        <div id="category-filter-box" class="filter-box hidden">
            <h3>Select category:</h3>

            {% for category in categories %}
                <label>
                    <input
                        type="checkbox"
                        name="categories[]"
                        value="{{ category.name }}"
                        class="cat-check"
                        {% if category.name in selectedCategories %}checked{% endif %}
                    >
                    {{ category.name }}
                </label><br>
            {% endfor %}

            <button onclick="applyCategoryFilter()" class="btn-filter-apply">Apply</button>
        </div>

        <!-- FILTER: YEAR -->
        <div id="year-filter-box" class="filter-box hidden">

            <label>From year: <span id="yearAfterValue">1950</span></label>
            <input type="range" id="yearAfter" name="yearAfter" min="1950" max="2025" value="1950"
                   oninput="yearAfterValue.textContent=this.value">

            <label>To year: <span id="yearBeforeValue">2025</span></label>
            <input type="range" id="yearBefore" name="yearBefore" min="1950" max="2025" value="2025"
                   oninput="yearBeforeValue.textContent=this.value">

            <button onclick="applyYearFilter()" class="btn-filter-apply">Apply</button>
        </div>

        <!-- FILTER: RATING -->
        <div id="score-filter-box" class="filter-box hidden">

            <label>Min rating: <span id="minScoreValue">0</span>%</label>
            <input type="range" id="minScore" min="0" max="100" value="0"
                   oninput="minScoreValue.textContent=this.value">

            <label>Max rating: <span id="maxScoreValue">100</span>%</label>
            <input type="range" id="maxScore" min="0" max="100" value="100"
                   oninput="maxScoreValue.textContent=this.value">

            <button onclick="applyScoreFilter()" class="btn-filter-apply">Apply</button>
        </div>

        <!-- RESULTS -->
        {% if movies is empty %}
            <div class="not-found">Could not find anything :(</div>
        {% else %}
        <div class="movies-grid">

            {% for movie in movies %}
                <div class="movie-card">

                    <div class="poster-wrapper">
                        <a href="{{ path('movie_show', {'id': movie.id}) }}" class="movie-link">
                            <img src="{{ movie.posterPath ?? 'https://placehold.co/300x450' }}" alt="">
                        </a>

                        <div class="heart" data-id="{{ movie.id }}">
                            {% include 'icons/heart.svg' %}
                        </div>
                    </div>

                    <div class="movie-title">{{ movie.title }}</div>

                    <div class="like-bar">
                        <span class="like-btn">üëç</span>
                        <span class="like-count">
                            {% if movie.allReviewsCount > 0 %}
                                {{ (movie.positiveReviewsCount / movie.allReviewsCount * 100) | round }}%
                            {% else %}
                                0%
                            {% endif %}
                        </span>
                    </div>

                </div>

            {% endfor %}

        </div>
        {% endif %}

    </div>

{% endblock %}

{% block scripts %}
    {{ parent() }}

    <script type="text/javascript" src="{{ asset('scripts/favorites.js') }}"
{% endblock %}
