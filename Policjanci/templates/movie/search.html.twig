{% extends 'base.html.twig' %}

{% block title %}Wyniki wyszukiwania ‚Äì PlusFlix{% endblock %}

{% block body %}

<div class="search-page">

    <!-- WYSZUKIWARKA -->
    <form action="{{ path('app_search') }}" method="get" class="search-form">
        <input type="text" name="prompt" placeholder="Wyszukaj..." value="{{ prompt }}" class="search-input">
        <button class="search-btn">üîç</button>
    </form>

    <!-- SERWISY -->
    <div class="service-label">Serwisy + filtry</div>

    <div class="service-icons">

        <div class="service-item">
            <img src="/apple.png" alt="Apple TV">
            <span>Apple TV</span>
        </div>

        <div class="service-item">
            <img src="/Netflix_Symbol_RGB.png" alt="Netflix">
            <span>Netflix</span>
        </div>

        <div class="service-item">
            <img src="/hbo-max-logo.jpg" alt="HBO Max">
            <span>HBO Max</span>
        </div>

        <div class="service-item">
            <img src="/disney_logo_march_2024_050fef2e.jpg" alt="Disney+">
            <span>Disney+</span>
        </div>

        <div class="service-item">
            <img src="/prime-logo-rgb-prime-blue-master.png" alt="Prime Video">
            <span>Prime Video</span>
        </div>

        <div class="service-item">
            <img src="/skyshowtime.jpg" alt="SkyShowtime">
            <span>SkyShowtime</span>
        </div>

    </div>

    {# ---- WYBRANE FILTRY ---- #}
    {% if selectedCategories is not empty 
        or prompt 
        or type 
        or minScore 
        or maxScore 
        or yearAfter 
        or yearBefore 
        or country 
        or isRated18 is not null %}

    <div class="selected-filters">
        <strong>Wybrane filtry:</strong>

        {% if prompt %}
            <span class="tag">Szukaj: "{{ prompt }}"</span>
        {% endif %}

        {% if selectedCategories is not empty %}
            <span class="tag">Gatunek: {{ selectedCategories|join(', ') }}</span>
        {% endif %}

        {% if type %}
            <span class="tag">Typ: {{ type == 'film' ? 'Film' : 'Serial' }}</span>
        {% endif %}

        {% if yearAfter or yearBefore %}
            <span class="tag">Rok: {{ yearAfter ?? '?' }} ‚Äì {{ yearBefore ?? '?' }}</span>
        {% endif %}

        {% if country %}
            <span class="tag">Kraj: {{ country }}</span>
        {% endif %}

        {% if minScore or maxScore %}
            <span class="tag">Ocena: {{ minScore ?? 0 }}‚Äì{{ maxScore ?? 100 }}</span>
        {% endif %}

        {% if isRated18 is not null %}
            <span class="tag">18+: {{ isRated18 ? 'Tak' : 'Nie' }}</span>
        {% endif %}

        <a href="{{ path('app_search') }}" class="clear-filters">Wyczy≈õƒá</a>
    </div>

    {% endif %}


    {# ---- PRZYCISKI FILTR√ìW ---- #}
    <div class="filter-bar">

        <a href="{{ path('app_search', app.request.query.all | merge({'type': null})) }}" class="filter-btn">Wszystkie</a>

        <a href="{{ path('app_search', app.request.query.all | merge({'type': 'film'})) }}" class="filter-btn">Filmy</a>

        <a href="{{ path('app_search', app.request.query.all | merge({'type': 'series'})) }}" class="filter-btn">Seriale</a>

        <a href="#" onclick="toggleCategoryFilter()" class="filter-btn">Gatunek</a>

        <a href="#" onclick="toggleYearFilter()" class="filter-btn">Rok produkcji</a>

        <a href="#" onclick="toggleCountryFilter()" class="filter-btn">Kraj produkcji</a>

        <a href="#" onclick="toggleScoreFilter()" class="filter-btn">Ocena</a>

        <a href="{{ path('app_search', app.request.query.all | merge({'isRated18': 1})) }}" class="filter-btn">18+</a>

        <a href="{{ path('app_search') }}" class="filter-btn reset">Resetuj</a>
    </div>




    <!-- FILTR: GATUNEK -->
    <div id="category-filter-box" class="filter-box hidden">
        <h3>Wybierz gatunek:</h3>

        {% for category in categories %}
            <label>
                <input 
                    type="checkbox" 
                    name="categories[]" 
                    value="{{ category.name }}"
                    class="cat-check"
                    {% if category.name in selectedCategories %}checked{% endif %}
                >
                {{ category.name }}
            </label><br>
        {% endfor %}

        <button onclick="applyCategoryFilter()" class="btn-filter-apply">Zastosuj</button>
    </div>

    <!-- FILTR: ROK PRODUKCJI -->
    <div id="year-filter-box" class="filter-box hidden">

        <label>Od roku: <span id="yearAfterValue">1950</span></label>
        <input type="range" id="yearAfter" name="yearAfter" min="1950" max="2025" value="1950"
               oninput="yearAfterValue.textContent=this.value">

        <label>Do roku: <span id="yearBeforeValue">2025</span></label>
        <input type="range" id="yearBefore" name="yearBefore" min="1950" max="2025" value="2025"
               oninput="yearBeforeValue.textContent=this.value">

        <button onclick="applyYearFilter()" class="btn-filter-apply">Zastosuj</button>
    </div>


    <!-- FILTR: OCENA -->
    <div id="score-filter-box" class="filter-box hidden">

        <label>Minimalna ocena: <span id="minScoreValue">0</span>%</label>
        <input type="range" id="minScore" min="0" max="100" value="0"
               oninput="minScoreValue.textContent=this.value">

        <label>Maksymalna ocena: <span id="maxScoreValue">100</span>%</label>
        <input type="range" id="maxScore" min="0" max="100" value="100"
               oninput="maxScoreValue.textContent=this.value">

        <button onclick="applyScoreFilter()" class="btn-filter-apply">Zastosuj</button>
    </div>



    <!-- WYNIKI -->
{% if movies is empty %}
    <div class="not-found">Nic nie znaleziono‚Ä¶</div>
{% else %}
<div class="movies-grid">

    {% for movie in movies %}
        <div class="movie-card">

            <!-- LINK ‚Äî tylko obraz i tytu≈Ç -->
            <a href="{{ path('movie_show', {'id': movie.id}) }}" class="movie-link">
                <img src="{{ movie.image ?? 'https://placehold.co/300x450' }}" alt="">
                <div class="movie-title">{{ movie.title }}</div>
            </a>

            <!-- ≈ÅAPKA POZA LINKIEM -->
            <div class="like-bar">
                <span class="like-btn" data-id="{{ movie.id }}">üëç</span>
                <span class="like-count" id="likes-{{ movie.id }}">{{ movie.likes ?? 0 }}</span>
            </div>

        </div>
    {% endfor %}

</div>
{% endif %}

</div>


<!-- STYLE ‚Äì LIKE BUTTON -->
<style>
.like-btn {
    cursor: pointer;
    margin-left: 10px;
    color: #aaa;
    transition: 0.2s;
}

.like-btn.liked {
    color: #00c853;
}

.like-count {
    margin-left: 5px;
    font-size: 14px;
    color: #ccc;
}
</style>


<!-- STYLE STRONY -->
<style>

.search-page { padding: 30px; }

/* FORMULARZ */
.search-form { width: 50%; margin: 0 auto; display: flex; }
.search-input {
    width: 100%; padding: 12px; background: #000;
    border: 1px solid #555; color: white; font-size: 16px;
}
.search-btn { width: 60px; background: #333; border: 1px solid #555; border-left: none; color: white; cursor: pointer; }
.search-btn:hover { background: #555; }

/* SERWISY */
.service-label { margin-top: 25px; font-size: 14px; color: #bbb; text-align: center; }
.service-icons { display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; }

.service-item { text-align: center; font-size: 12px; color: #ccc; }
.service-item img { width: 40px; height: 40px; object-fit: contain; margin-bottom: 5px; }

/* FILTRY */
.filter-bar { display: flex; justify-content: center; gap: 12px; margin-bottom: 25px; flex-wrap: wrap; }
.filter-btn {
    background: #2d2d2d; padding: 6px 14px; border-radius: 4px;
    font-size: 14px; color: white; border: 1px solid #444;
}
.filter-btn:hover { background: #444; }
.reset { background: #a80000; }

/* FILTR OKNA */
.filter-box {
    background: #111; border: 1px solid #444; padding: 20px; width: 50%;
    margin: 10px auto; border-radius: 6px; color: white; text-align: center;
}
.hidden { display: none; }

/* FILMY */
.movies-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 20px;
}
.movie-card { background: #1f1f1f; border-radius: 4px; overflow: hidden; transition: .3s; }
.movie-card img { width: 100%; height: 230px; object-fit: cover; }
.movie-card:hover { transform: scale(1.05); }
.movie-title { text-align: center; padding: 10px; }

.not-found { text-align: center; font-size: 18px; color: #bbb; margin-top: 30px; }

.selected-filters {
    background: #111;
    padding: 10px 20px;
    border: 1px solid #333;
    width: 80%;
    margin: 10px auto 25px;
    border-radius: 6px;
    color: #eee;
}

.tag {
    background: #333;
    padding: 5px 10px;
    border-radius: 4px;
    margin-right: 8px;
    display: inline-block;
    margin-top: 5px;
}

.clear-filters {
    margin-left: 10px;
    color: #e50914;
    font-weight: bold;
}

.like-bar {
    text-align: center;
    padding: 6px;
    background: #151515;
}

</style>


<!-- LIKE BUTTON ‚Äì SKRYPT -->
<script>
document.addEventListener("DOMContentLoaded", () => {

    document.querySelectorAll(".like-btn").forEach(btn => {
        const movieId = btn.dataset.id;
        const key = "likes_" + movieId;

        // Wczytaj z localStorage
        let count = localStorage.getItem(key) || 0;
        let liked = localStorage.getItem(key + "_pressed");

        document.getElementById("likes-" + movieId).textContent = count;

        if (liked) btn.classList.add("liked");

        // Klikniƒôcie ≈Çapki ‚Äî NIE OTWIERA LINKA
        btn.addEventListener("click", (event) => {
            event.stopPropagation();
            event.preventDefault();

            if (btn.classList.contains("liked")) return;

            count++;
            localStorage.setItem(key, count);
            localStorage.setItem(key + "_pressed", true);

            btn.classList.add("liked");
            document.getElementById("likes-" + movieId).textContent = count;
        });

    });

});
</script>

{% endblock %}
